# ./docker/dockerfile.db
FROM timescale/timescaledb:latest-pg17

LABEL maintainer="Zbyszko Sobecki"
LABEL description="PostgreSQL with TimescaleDB and pg_uuidv7 extension for engineering thesis application"

# Install essential tools
RUN apk add --no-cache \
    curl \
    bash 

# --- Environment defaults (you can override via docker-compose) ---
# ENV POSTGRES_USER=postgres
# ENV POSTGRES_PASSWORD=postgres
# ENV POSTGRES_DB=inzynierka

# --- Install pg_uuidv7 extension during build (as root)
RUN set -e \
    && TEMP_DIR=$(mktemp -d) \
    && cd "$TEMP_DIR" \
    && curl -LO "https://github.com/fboulnois/pg_uuidv7/releases/download/v1.7.0/pg_uuidv7.tar.gz" \
    && curl -LO "https://github.com/fboulnois/pg_uuidv7/releases/download/v1.7.0/SHA256SUMS" \
    && tar xf pg_uuidv7.tar.gz \
    && sha256sum -c SHA256SUMS \
    && PG_MAJOR=$(pg_config --version | sed 's/^.* \([0-9]\{1,\}\).*$/\1/') \
    && cp "${PG_MAJOR}/pg_uuidv7.so" "$(pg_config --pkglibdir)/" \
    && cp pg_uuidv7--1.7.sql pg_uuidv7.control "$(pg_config --sharedir)/extension/" \
    && cd / \
    && rm -rf "$TEMP_DIR" \
    && echo "pg_uuidv7 extension installed successfully"

# --- Copy SQL setup scripts (executed automatically at first start) ---
# Any .sql or .sh file in /docker-entrypoint-initdb.d runs ONCE on init
COPY db/setup/* /docker-entrypoint-initdb.d/

# --- Optional: custom config (tuning, extensions, logging) ---
# COPY ./postgresql.conf /etc/postgresql/postgresql.conf
# COPY ./pg_hba.conf /etc/postgresql/pg_hba.conf

# --- Optional: extra permissions or health check ---
HEALTHCHECK --interval=10s --timeout=5s --retries=5 \
  CMD pg_isready -U $POSTGRES_USER -d $POSTGRES_DB || exit 1

EXPOSE 5432
